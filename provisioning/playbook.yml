---
#Playbook for case 1a
- name: Verify control node prerequisites
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check for ansible.windows collection
      ansible.builtin.command:
        # --format json is supported on ansible-core 2.13+. If unavailable, run
        # provisioning/run_playbook.sh to install required collections with a
        # compatible Ansible version.
        cmd: ansible-galaxy collection list ansible.windows --format json
      register: ansible_windows_collection
      changed_when: false
      failed_when: ansible_windows_collection.rc != 0

    - name: Parse ansible.windows collection metadata
      ansible.builtin.set_fact:
        ansible_windows_collections: >-
          {{
            ansible_windows_collection.stdout
            | from_json
            | dict2items
            | selectattr('value', 'mapping')
            | map(attribute='value')
            | map('dict2items')
            | flatten
            | selectattr('key', 'equalto', 'ansible.windows')
            | items2dict(key_name='key', value_name='value')
          }}

    - name: Abort when ansible.windows collection is missing
      ansible.builtin.assert:
        that:
          - >-
            ansible_windows_collections | dict2items |
            selectattr('key', 'equalto', 'ansible.windows') |
            list | length > 0
        fail_msg: >-
          The ansible.windows collection is missing. Run provisioning/run_playbook.sh to
          install required collections before executing this playbook directly.
        success_msg: ansible.windows collection is available.

- name: Configure REP core services
  hosts: rep-scheduler, rep-live-session, rep-quiz-engine, rep-practical-labs
  become: true
  roles:
    - role: rep-core

- name: Prepare the reporting workspace analytics stack
  hosts: reporting-workspace
  become: true
  roles:
    - role: reporting-workspace

- name: Personalise the instructor console
  hosts: instructor-console
  become: true
  roles:
    - role: instructor-console

- name: Stage trainee lab resources
  hosts: trainee-workstation-01, trainee-workstation-02
  roles:
    - role: trainee-workstation
