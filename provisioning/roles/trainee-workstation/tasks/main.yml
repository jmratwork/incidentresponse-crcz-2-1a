---
- name: Ensure REP data directory exists
  ansible.windows.win_file:
    path: "{{ trainee_workstation_collector.directory }}"
    state: directory
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Ensure trainee labs directory exists
  ansible.windows.win_file:
    path: "{{ trainee_workstation_welcome_note.directory }}"
    state: directory
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Ensure collector script directory exists
  ansible.windows.win_file:
    path: "{{ trainee_workstation_collector_script_path | regex_replace('\\\\[^\\\\]+$', '') }}"
    state: directory
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Deploy trainee welcome note
  ansible.windows.win_copy:
    dest: "{{ trainee_workstation_welcome_note.path | default(trainee_workstation_welcome_note.directory ~ '\\\\' ~ trainee_workstation_welcome_note.filename) }}"
    content: "{{ trainee_workstation_welcome_note.content }}"
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Deploy collector configuration
  ansible.windows.win_template:
    src: collector.yaml.j2
    dest: "{{ trainee_workstation_collector.config_path }}"
  when: ansible_facts.os_family | default('') == 'Windows'
  notify: restart rep collector
  no_log: true

- name: Deploy collector PowerShell script
  ansible.windows.win_template:
    src: collector.ps1.j2
    dest: "{{ trainee_workstation_collector_script_path }}"
  when: ansible_facts.os_family | default('') == 'Windows'
  notify: restart rep collector

- name: Determine collector service wrapper architecture
  ansible.builtin.set_fact:
    trainee_workstation_nssm_arch: "{{ 'win64' if (ansible_processor_architecture | default(ansible_architecture | default('')) | lower | regex_search('amd64|x86_64|64')) else 'win32' }}"
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Set collector service wrapper executable path
  ansible.builtin.set_fact:
    trainee_workstation_nssm_path: "{{ trainee_workstation_collector.service_wrapper.extract_path ~ '\\\\nssm-2.24\\\\' ~ trainee_workstation_nssm_arch ~ '\\\\nssm.exe' }}"
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Configure collector service wrapper executable path
  ansible.builtin.set_fact:
    trainee_workstation_collector: "{{ trainee_workstation_collector | combine({'service_wrapper': trainee_workstation_collector.service_wrapper | combine({'exe_path': trainee_workstation_nssm_path})}) }}"
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Determine collector service wrapper source type
  ansible.builtin.set_fact:
    trainee_workstation_service_wrapper_remote: "{{ trainee_workstation_collector.service_wrapper.url is match('^https?://') }}"
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Check for existing collector service wrapper archive
  ansible.windows.win_stat:
    path: "{{ trainee_workstation_collector.service_wrapper.archive_path }}"
  register: trainee_workstation_service_wrapper_archive
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Copy bundled collector service wrapper
  ansible.windows.win_copy:
    src: "{{ trainee_workstation_collector.service_wrapper.url }}"
    dest: "{{ trainee_workstation_collector.service_wrapper.archive_path }}"
    force: false
  when:
    - ansible_facts.os_family | default('') == 'Windows'
    - not trainee_workstation_service_wrapper_remote
    - not trainee_workstation_service_wrapper_archive.stat.exists

- name: Download collector service wrapper
  ansible.windows.win_get_url:
    url: "{{ trainee_workstation_collector.service_wrapper.url }}"
    dest: "{{ trainee_workstation_collector.service_wrapper.archive_path }}"
    force: false
  when:
    - ansible_facts.os_family | default('') == 'Windows'
    - trainee_workstation_service_wrapper_remote
    - not trainee_workstation_service_wrapper_archive.stat.exists

- name: Extract collector service wrapper
  community.windows.win_unzip:
    src: "{{ trainee_workstation_collector.service_wrapper.archive_path }}"
    dest: "{{ trainee_workstation_collector.service_wrapper.extract_path }}"
    creates: "{{ trainee_workstation_nssm_path }}"
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Validate collector service wrapper extraction
  ansible.windows.win_stat:
    path: "{{ trainee_workstation_nssm_path }}"
  register: trainee_workstation_nssm_stat
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Fail when collector service wrapper is missing
  ansible.builtin.fail:
    msg: "Collector service wrapper binary not found at {{ trainee_workstation_nssm_path }}. Verify extraction of {{ trainee_workstation_collector.service_wrapper.archive_path }}."
  when:
    - ansible_facts.os_family | default('') == 'Windows'
    - not trainee_workstation_nssm_stat.stat.exists

- name: Publish trainee shortcuts
  ansible.windows.win_template:
    src: shortcut.url.j2
    dest: "{{ shortcut.path }}"
  loop: "{{ trainee_workstation_shortcuts | list }}"
  loop_control:
    loop_var: shortcut
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Ensure collector service is running
  community.windows.win_nssm:
    name: "{{ trainee_workstation_collector.service_name }}"
    application: "{{ trainee_workstation_collector.service_binary }}"
    arguments: "{{ trainee_workstation_collector.service_args }}"
    executable: "{{ trainee_workstation_nssm_path }}"
    start_mode: auto
    state: started
  when: ansible_facts.os_family | default('') == 'Windows'

- name: Validate collector service status
  ansible.windows.win_shell: "{{ trainee_workstation_health_command }}"
  register: trainee_collector_health
  changed_when: false
  until: trainee_collector_health.rc == 0 and 'Running' in trainee_collector_health.stdout
  retries: 5
  delay: 5
  failed_when: trainee_collector_health.rc != 0 or 'Running' not in trainee_collector_health.stdout
  when: ansible_facts.os_family | default('') == 'Windows'
