- name: Configure Grafana repositories
  when: reporting_workspace_grafana_repositories | length > 0
  ansible.builtin.include_tasks: configure_grafana_repository.yml
  loop: "{{ reporting_workspace_grafana_repositories }}"
  loop_control:
    loop_var: grafana_repository
    label: "{{ grafana_repository.name | default(grafana_repository.apt_repository.repo | default('grafana repository')) }}"

- name: Install Grafana package
  ansible.builtin.package:
    name: "{{ reporting_workspace_grafana_package }}"
    state: present

- name: Ensure Grafana service is enabled and started
  ansible.builtin.service:
    name: "{{ reporting_workspace_grafana_service }}"
    enabled: true
    state: started
  notify: restart grafana

- name: Ensure grafana group exists
  ansible.builtin.group:
    name: grafana
    system: true

- name: Ensure grafana user exists
  ansible.builtin.user:
    name: grafana
    group: grafana
    system: true

- name: Ensure Grafana provisioning directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: grafana
    mode: "0750"
  loop:
    - "{{ reporting_workspace_datasource_template | dirname }}"
    - "{{ reporting_workspace_dashboards_dir }}"

- name: Deploy Grafana main configuration
  ansible.builtin.template:
    src: grafana.ini.j2
    dest: "{{ reporting_workspace_grafana_ini }}"
    owner: root
    group: root
    mode: "0640"
  notify: restart grafana

- name: Configure Grafana data sources for REP
  ansible.builtin.template:
    src: datasources.yaml.j2
    dest: "{{ reporting_workspace_datasource_template }}"
    owner: root
    group: grafana
    mode: "0640"
  notify: restart grafana
  no_log: true

- name: Register Grafana dashboard providers
  ansible.builtin.template:
    src: dashboards.yaml.j2
    dest: "{{ reporting_workspace_dashboards_dir }}/rep-provider.yaml"
    owner: root
    group: grafana
    mode: "0640"
  notify: restart grafana

- name: Ensure dashboard folders exist
  ansible.builtin.file:
    path: "{{ reporting_workspace_dashboards_dir }}/{{ dashboard.folder | lower }}"
    state: directory
    owner: root
    group: grafana
    mode: "0750"
  loop: "{{ reporting_workspace_dashboards | list }}"
  loop_control:
    loop_var: dashboard

- name: Deploy REP dashboards
  ansible.builtin.template:
    src: dashboard.json.j2
    dest: "{{ reporting_workspace_dashboards_dir }}/{{ dashboard.folder | lower }}/{{ dashboard.file }}"
    owner: root
    group: grafana
    mode: "0640"
  loop: "{{ reporting_workspace_dashboards | list }}"
  loop_control:
    loop_var: dashboard
  notify: restart grafana

- name: Wait for Grafana service port to become available
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: 3000
    timeout: 30
    sleep: 1
  when:
    - reporting_workspace_healthcheck is defined
    - reporting_workspace_healthcheck.url | length > 0

- name: Validate Grafana is responding
  ansible.builtin.uri:
    url: "{{ reporting_workspace_healthcheck.url }}"
    method: GET
    status_code: >-
      {{
        [reporting_workspace_healthcheck.status_code | int]
        + (
          reporting_workspace_healthcheck.status_code_alternatives | default([])
          | map('int')
          | list
        )
      }}
    return_content: true
    headers:
      Accept: application/json
  register: reporting_workspace_health
  failed_when:
    - >-
      {{
        (reporting_workspace_health.json is not defined)
        | ternary(
          reporting_workspace_healthcheck.failed_when_non_json
          | default(
            'Grafana health endpoint {} did not return JSON. Status: {}, Body: {}'
            | format(
              reporting_workspace_healthcheck.url,
              reporting_workspace_health.status | default('unknown'),
              reporting_workspace_health.content | default('') | truncate(200, True, '...')
            ),
            true
          ),
          False
        )
      }}
    - >-
      {{
        reporting_workspace_health.json is defined
        and (reporting_workspace_health.json.database | default('')) != 'ok'
      }}
  changed_when: false
  when:
    - reporting_workspace_healthcheck is defined
    - reporting_workspace_healthcheck.url | length > 0
